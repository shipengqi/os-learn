# Linux 文件系统和 IO

文件系统，本身是对存储设备上的文件，进行组织管理的机制。组织方式不同，就会形成不同的文件系统。

Linux 为每个文件都分配了两个数据结构，**索引节点**（index node）和**目录项**（directory entry）。

- 索引节点，inode，记录文件元数据，如 inode 编号，文件大小，访问权限，修改日期，数据的位置等。inode 和文件一一对应，和文件内容都会持久化到磁盘中。所以 inode 会占用磁盘空间。
- 目录项，dentry，记录文件的名字，inode 指针以及与其他 dentry 的关联关系。多个关联的 dentry 就构成文件系统的目录结构。**目录项内核维护的内存数据结构**，叫做目录项缓存。

**inode 是每个文件的唯一标志，dentry 维护的是文件系统的树状结构**。dentry 和 inode 的关系是多对一，可以简单理解为，一个文件可以有多个别名。

inode 和文件内容都会缓存到页缓存 Cache 中，来加速文件的访问。

磁盘在执行文件系统格式化时，会被分成三个存储区域：

- 超级块，存储整个文件系统的状态。
- 索引节点区，用来存储索引节点。
- 数据块区，则用来存储文件数据。

## 虚拟文件系统 VFS

为了支持各种不同的文件系统，Linux 内核在用户进程和文件系统的中间，又引入了一个抽象层，也就是虚拟文件系统 VFS（Virtual File System）。用户进程和内核中的其他子系统，只需要跟 VFS 提供的统一接口进行交互就可以了，而不需要再关心底层各种文件系统的实现细节。

文件系统可以分为三类：

- 基于磁盘的文件系统，也就是把数据直接存储在计算机本地挂载的磁盘中。常见的 Ext4、XFS、OverlayFS 等，都是这类文件系统。
- 基于内存的文件系统，也就是我们常说的虚拟文件系统。这类文件系统，不需要任何磁盘分配存储空间，但会占用内存。我们经常用到的 `/proc` 文件系统，其实就是一种最常见的虚拟文件系统。此外，`/sys` 文件系统也属于这一类，主要向用户空间导出层次化的内核对象。
- 网络文件系统，也就是用来访问其他计算机数据的文件系统，比如 NFS、SMB、iSCSI 等。

这些文件系统，要先挂载到 VFS 目录树中的某个子目录（称为挂载点），然后才能访问其中的文件。

如基于磁盘的文件系统，在安装系统时，要先挂载一个根目录（`/`），在根目录下再把其他文件系统（比如其他的磁盘分区、`/proc` 文件系统、`/sys` 文件系统、NFS 等）挂载进来。

### 文件系统 IO

文件系统 IO 可以分为四类：

1. 缓冲 IO 与非缓冲 IO，“缓冲”，是指标准库内部实现的缓存。很多程序遇到换行时才真正输出，而换行前的内容，其实就是被标准库暂时缓存了起来。
    - 缓冲 IO，是指利用标准库缓存来加速文件的访问，而标准库内部再通过系统调度访问文件。
    - 非缓冲 IO是指直接通过系统调用来访问文件，不再经过标准库缓存。
2. 直接 IO 与非直接 IO
    - 直接 IO，是指跳过操作系统的页缓存，直接跟文件系统交互来访问文件。在系统调用中，指定 `O_DIRECT` 标志。如果没有设置过，默认的是非直接 IO。
    - 非直接 IO，文件读写时，先要经过系统的页缓存，然后再由内核或额外的系统调用，真正写入磁盘。
    - 直接 IO、非直接 IO，本质上还是和文件系统交互。如果是在数据库等场景中，你还会看到，跳过文件系统读写磁盘的情况，也就是我们通常所说的**裸 IO**。
3. 阻塞 IO 和非阻塞 IO
    - 阻塞 IO，是指应用程序执行 IO 操作后，如果没有获得响应，就会阻塞当前线程，自然就不能执行其他任务。
    - 非阻塞 IO，是指应用程序执行 IO 操作后，不会阻塞当前的线程，可以继续执行其他的任务，随后再通过轮询或者事件通知的形式，获取调用的结果。
4. 同步和异步 IO
    - 同步 IO，是指应用程序执行 IO 操作后，要一直等到整个 IO 完成后，才能获得 IO 响应。
    - 异步 IO，是指应用程序执行 IO 操作后，不用等待完成和完成后的响应，而是继续执行就可以。等到这次 IO 完成后，响应会用事件通知的方式，告诉应用程序。

阻塞和非阻塞和同步和异步，其实就是两个不同角度的 IO 划分方式。它们描述的对象也不同，阻塞和非阻塞针对的是 IO 调用者（即应用程序），而同步和异步针对的是 IO 执行者（即系统）。
执行者（即系统）

同步和异步关注的是**消息通信机制**
阻塞和非阻塞关注的是**程序在等待调用结果（消息，返回值）时的状态**.

<https://www.zhihu.com/question/19732473>

内核使用 Slab 机制，管理目录项和索引节点的缓存。`/proc/meminfo` 只给出了 Slab 的整体大小，具体到每一种 Slab 缓存，还要查看 `/proc/slabinfo` 这个文件。

## 磁盘

磁盘可以分为两类：

- 机械磁盘，也叫硬盘驱动器（Hard Disk Driver，HDD）。主要由盘片和读写磁头组成，数据存储在盘片的环状磁道中。读写数据，需要移动磁头，定位到数据所在的磁道，才能访问数据。显然，如果 IO 请求刚好连续，那就不需要磁道寻址，自然可以获得最佳性能。这其实就是我们熟悉的，**连续 IO** 的工作原理。与之相对应的，就是**随机 IO**，它需要不停地移动磁头，来定位数据位置，所以读写速度就会比较慢。
- 固态磁盘（Solid State Disk，SSD），由固态电子元器件组成。固态磁盘不需要磁道寻址，所以不管是连续 IO 还是随机 IO 的性能，都比机械磁盘好的多。

但是，**无论机械磁盘，还是固态磁盘，相同磁盘的随机 IO 都要比连续 IO 慢很多**。

- 对机械磁盘来说，由于随机 IO 需要更多的磁头寻道和盘片旋转，它的性能自然要比连续 IO 慢。
- 而对固态磁盘来说，虽然它的随机性能比机械硬盘好很多，但同样存在“先擦除再写入”的限制。随机读写会导致大量的垃圾回收，所以随机 IO 的性能比起连续 IO 来，也还是差了很多。
- 连续 IO 还可以通过预读的方式，来减少 IO 请求的次数，这也是其性能优异的一个原因。很多性能优化的方案，也都会从这个角度出发，来优化 IO 性能。
- 机械磁盘的最小读写单位是扇区，一般大小为 512 字节。而固态磁盘的最小读写单位是页，通常大小是 4KB、8KB 等。如果每次都读写 512 字节这么小的单位的话，效率很低。所以，文件系统会把连续的扇区或页，组成逻辑块，然后以逻辑块作为最小单元来管理数据。常见的逻辑块的大小是 4KB，也就是说，连续 8 个扇区，或者单独的一个页，都可以组成一个逻辑块。

## 磁盘 IO

![](linux-storage-stack.png)

- 文件系统层，包括虚拟文件系统和其他各种文件系统的具体实现。为上层的应用程序，提供标准的文件访问接口。对下会通过通用块层，来存储和管理磁盘数据。
- 通用块层，包括块设备 IO 队列和 IO 调度器。对文件系统的 IO 请求进行排队，再通过重新排序和请求合并，然后发送给下一级设备层。
- 设备层，包括存储设备和相应的驱动程序，负责最终的物理设备的 IO 操作。

## 磁盘性能指标

- 使用率，指磁盘处理 IO 的时间百分比。使用率过高（如 80%），就意味着磁盘 IO 存在瓶颈。
- 饱和度，指磁盘处理 IO 的繁忙程度。饱和度过高，意味着严重的性能瓶颈。饱和度达到 100% 时，就无法再接受新的 IO 请求。
- IOPS（Input/Output Per Second），每秒的 IO 请求数。
- 吞吐量，每秒的 IO 请求大小。
- 响应时间，IO 请求从发出到收到相应的间隔时间。

一般情况下，选择服务器时，先对磁盘 IO 进行性能基准测试，以便评估磁盘性能是否可与满足应用的需求。

性能测试工具 fio。

### 磁盘 IO 观测

- `iostat` 最常用的磁盘 IO 性能观测工具，提供了磁盘的使用率，IOPS，吞吐量等，指标实际来自 `/proc/diskstats`。
- `pidstat`
- `iotop` 是一个类似于 top 的工具，你可以按照 IO 大小对进程排序，然后找到 IO 较大的那些进程。

### 案例

## IO 性能分析

### 文件 IO 性能指标

- 存储空间的使用情况，包括容量、使用量以及剩余空间，这些只是文件系统向外展示的空间使用，而非在磁盘空间的真实用量，因为文件系统的元数据也会占用磁盘空间。
- 索引节点的使用情况，它也包括容量、使用量以及剩余量等三个指标。如果文件系统中存储过多的小文件，就可能碰到索引节点容量已满的问题。
- 缓存使用情况，包括页缓存、目录项缓存、索引节点缓存以及各个具体文件系统（如 ext4、XFS 等）的缓存。这些缓存会使用速度更快的内存，用来临时存储文件数据或者文件系统的元数据，从而可以减少访问慢速磁盘的次数。
- IOPS（包括 `r/s` 和 `w/s`）、响应时间（延迟）以及吞吐量（B/s）等

### 磁盘 IO 性能指标

### 性能工具

- `df`，查看文件系统容量的工具，可以查看文件系统数据的空间容量，也可以查看索引节点的容量。
- `/proc/meminfo` `/proc/slabinfo` `slabtop` 可以用来观察页缓存，目录项缓存，索引节点缓存以及文件系统的缓存情况。
- `iostat` 可以得到磁盘的 IO 使用率、吞吐量、响应时间以及 IOPS 等性能指标
- `pidstat`可以观察到进程的 IO 吞吐量以及块设备 IO 的延迟等。
- `strace`
- `lsof`
- `filetop`
- `opensnoop`
