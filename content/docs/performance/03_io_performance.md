# Linux 文件系统和 IO

文件系统，本身是对存储设备上的文件，进行组织管理的机制。组织方式不同，就会形成不同的文件系统。

## 磁盘

磁盘可以分为两类：

- 机械磁盘，也叫硬盘驱动器（Hard Disk Driver，HDD）。主要由盘片和读写磁头组成，数据存储在盘片的环状磁道中。读写数据，需要移动磁头，定位到数据所在的磁道，才能访问数据。显然，如果 IO 请求刚好连续，那就不需要磁道寻址，自然可以获得最佳性能。这其实就是我们熟悉的，**连续 IO** 的工作原理。与之相对应的，就是**随机 IO**，它需要不停地移动磁头，来定位数据位置，所以读写速度就会比较慢。
- 固态磁盘（Solid State Disk，SSD），由固态电子元器件组成。固态磁盘不需要磁道寻址，所以不管是连续 IO 还是随机 IO 的性能，都比机械磁盘好的多。

但是，**无论机械磁盘，还是固态磁盘，相同磁盘的随机 IO 都要比连续 IO 慢很多**。

- 对机械磁盘来说，由于随机 IO 需要更多的磁头寻道和盘片旋转，它的性能自然要比连续 IO 慢。
- 而对固态磁盘来说，虽然它的随机性能比机械硬盘好很多，但同样存在“先擦除再写入”的限制。随机读写会导致大量的垃圾回收，所以随机 IO 的性能比起连续 IO 来，也还是差了很多。
- 连续 IO 还可以通过预读的方式，来减少 IO 请求的次数，这也是其性能优异的一个原因。很多性能优化的方案，也都会从这个角度出发，来优化 IO 性能。
- 机械磁盘的最小读写单位是扇区，一般大小为 512 字节。而固态磁盘的最小读写单位是页，通常大小是 4KB、8KB 等。如果每次都读写 512 字节这么小的单位的话，效率很低。所以，文件系统会把连续的扇区或页，组成逻辑块，然后以逻辑块作为最小单元来管理数据。常见的逻辑块的大小是 4KB，也就是说，连续 8 个扇区，或者单独的一个页，都可以组成一个逻辑块。

## 磁盘 IO

![](linux-storage-stack.png)

- 文件系统层，包括虚拟文件系统和其他各种文件系统的具体实现。为上层的应用程序，提供标准的文件访问接口。对下会通过通用块层，来存储和管理磁盘数据。
- 通用块层，包括块设备 IO 队列和 IO 调度器。对文件系统的 IO 请求进行排队，再通过重新排序和请求合并，然后发送给下一级设备层。
- 设备层，包括存储设备和相应的驱动程序，负责最终的物理设备的 IO 操作。

## 磁盘性能指标

- 使用率，指磁盘处理 IO 的时间百分比。使用率过高（如 80%），就意味着磁盘 IO 存在瓶颈。
- 饱和度，指磁盘处理 IO 的繁忙程度。饱和度过高，意味着严重的性能瓶颈。饱和度达到 100% 时，就无法再接受新的 IO 请求。
- IOPS（Input/Output Per Second），每秒的 IO 请求数。
- 吞吐量，每秒的 IO 请求大小。
- 响应时间，IO 请求从发出到收到相应的间隔时间。
